# === Preprocessing Pipeline Config (YAML, HPC; multi-dataset) ===
# Use:
#   python preprocess_pipeline.py \
#     --config /scratch/st-ipor-1/cperez/MedSAM/bounding_box/preprocess/preprocess_pipeline_hpc.yaml

# ---- Core project paths (outputs live on scratch) ----
project_dir: "/scratch/st-ipor-1/cperez/MedSAM"
labels_dir:  "/scratch/st-ipor-1/cperez/MedSAM/bounding_box/data/labels"
yolo_split:  "/scratch/st-ipor-1/cperez/MedSAM/bounding_box/data/yolo_split"
yolo_aug:    "/scratch/st-ipor-1/cperez/MedSAM/bounding_box/data/yolo_split_aug"
yolo_roi:    "/scratch/st-ipor-1/cperez/MedSAM/bounding_box/data/yolo_split_cupROI"
viz_out:     "/scratch/st-ipor-1/cperez/MedSAM/bounding_box/data/viz_labels"

# NOTE: When using the multi-dataset block below, these top-level inputs are ignored by the 'masks' stage.
# They remain for backward-compatibility and for starting at later stages if needed.
images_root: "/arc/project/st-ipor-1/carlosp/fundus_data/SMDG-19/full-fundus/full-fundus"
disc_masks:  "/arc/project/st-ipor-1/carlosp/fundus_data/SMDG-19/optic-disc/optic-disc"
cup_masks:   "/arc/project/st-ipor-1/carlosp/fundus_data/SMDG-19/optic-cup/optic-cup"

# ---- Which stages to run ----
all: true
steps: null   # Use when 'all' is false, e.g., ["split","augment"]

# ---- Small subset mode (E2E sanity check) ----
subset_n: 0
subset_seed: 1234
subset_copy: false

# ---- Common flags ----
write_yaml: true
dry_run: false
verbose: false

# ---- masks_to_boxes.py defaults (used if per-dataset key omitted) ----
pad_pct: 0.0
min_area_px: 25
largest_only: false
require_both: false
recursive: false
masks_extra: ""

# ---- split_yolo.py ----
val_frac: 0.15
test_frac: 0.15
seed: 1337
copy: false        # symlinks save space; set true if your HPC disallows symlinks
patient_regex: ""  # set if you need a custom patient grouping rule
split_extra: ""

# ---- augment_yolo_ds.py (external config) ----
aug_yaml: "/scratch/st-ipor-1/cperez/MedSAM/bounding_box/preprocess/augment_config.yaml"
augment_splits: ["train","val","test"]

# ---- build_cup_roi_dataset.py ----
roi_pad_pct: 0.10
keep_roi_negatives: false
roi_extra: ""

# ---- viz_yolo_two_boxes.py ----
viz_sample: 12
viz_alpha: 0.25
viz_save_crops: false
viz_make_montage: false
viz_extra: ""

# ---- Multi-dataset (SMDG-19 + RIM-ONE on HPC) ----
datasets:
  - tag: smdg19
    images_root: "/arc/project/st-ipor-1/carlosp/fundus_data/SMDG-19/full-fundus/full-fundus"
    disc_masks:  "/arc/project/st-ipor-1/carlosp/fundus_data/SMDG-19/optic-disc/optic-disc"
    cup_masks:   "/arc/project/st-ipor-1/carlosp/fundus_data/SMDG-19/optic-cup/optic-cup"
    recursive: false
    exclude_name_contains: ["PAPILA"]

  - tag: rimone
    images_root: "/arc/project/st-ipor-1/carlosp/fundus_data/Rim-One/Organized_Rim-One/fundus"
    disc_masks:  "/arc/project/st-ipor-1/carlosp/fundus_data/Rim-One/Organized_Rim-One/optic-disc"
    cup_masks:   "/arc/project/st-ipor-1/carlosp/fundus_data/Rim-One/Organized_Rim-One/optic-cup"
    recursive: true   # often nested; safest to enable

# Unionized images + labels (assembled on scratch, then used by split/augment/roi/viz)
union_images_root: "/scratch/st-ipor-1/cperez/MedSAM/bounding_box/data/_union/images"
union_labels_dir:  "/scratch/st-ipor-1/cperez/MedSAM/bounding_box/data/_union/labels"